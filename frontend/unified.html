<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ChatMode | Unified Console</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b1118;
      --bg-2: #0f1c2b;
      --panel: rgba(13, 22, 38, 0.95);
      --panel-2: rgba(18, 32, 54, 0.9);
      --border: rgba(255, 255, 255, 0.08);
      --accent: #2dd4bf;
      --accent-2: #f59e0b;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --danger: #fb7185;
      --success: #22c55e;
      --shadow: 0 20px 50px rgba(2, 6, 23, 0.45);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Space Grotesk", sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 10% -20%, rgba(45, 212, 191, 0.16), transparent 60%),
        radial-gradient(900px 500px at 95% 0%, rgba(245, 158, 11, 0.16), transparent 60%),
        linear-gradient(160deg, var(--bg), var(--bg-2));
      min-height: 100vh;
      padding: 28px;
    }

    .wrap {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    header {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 20px;
      align-items: center;
    }

    .brand {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 24px 28px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    .brand::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(500px 140px at 20% 0%, rgba(45, 212, 191, 0.14), transparent 60%);
      pointer-events: none;
    }

    .brand-content {
      display: flex;
      align-items: center;
      gap: 28px;
      position: relative;
      z-index: 1;
    }

    .ascii-art {
      font-family: "IBM Plex Mono", monospace;
      font-size: 0.55rem;
      line-height: 1.1;
      color: var(--accent);
      white-space: pre;
      text-shadow: 0 0 20px rgba(45, 212, 191, 0.5);
      animation: pulse-glow 3s ease-in-out infinite;
      flex-shrink: 0;
    }

    @keyframes pulse-glow {
      0%, 100% { text-shadow: 0 0 20px rgba(45, 212, 191, 0.5); }
      50% { text-shadow: 0 0 35px rgba(45, 212, 191, 0.8), 0 0 60px rgba(45, 212, 191, 0.4); }
    }

    .brand-text {
      flex: 1;
    }

    .eyebrow {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.26em;
      color: var(--muted);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .eyebrow::before {
      content: "‚óÜ";
      color: var(--accent);
      animation: blink 2s ease-in-out infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    h1 {
      font-size: 2.2rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      margin-bottom: 10px;
      background: linear-gradient(135deg, var(--text) 0%, var(--accent) 50%, var(--accent-2) 100%);
      background-size: 200% 200%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: gradient-shift 5s ease infinite;
    }

    @keyframes gradient-shift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .subtitle {
      color: var(--muted);
      font-size: 0.95rem;
      line-height: 1.5;
    }

    .feature-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 14px;
    }

    .badge {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 5px 10px;
      border-radius: 20px;
      background: rgba(45, 212, 191, 0.1);
      border: 1px solid rgba(45, 212, 191, 0.3);
      color: var(--accent);
      transition: all 0.2s ease;
    }

    .badge:hover {
      background: rgba(45, 212, 191, 0.2);
      transform: translateY(-1px);
    }

    .badge.orange {
      background: rgba(245, 158, 11, 0.1);
      border-color: rgba(245, 158, 11, 0.3);
      color: var(--accent-2);
    }

    .badge.orange:hover {
      background: rgba(245, 158, 11, 0.2);
    }

    @media (max-width: 768px) {
      .brand-content {
        flex-direction: column;
        text-align: center;
      }
      .ascii-art {
        font-size: 0.4rem;
      }
      .feature-badges {
        justify-content: center;
      }
    }

    .status-card {
      background: var(--panel-2);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 22px 24px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 14px;
      min-width: 300px;
      position: relative;
      overflow: hidden;
    }

    .status-card::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent), var(--accent-2), var(--accent));
      background-size: 200% 100%;
      animation: status-bar 3s linear infinite;
    }

    @keyframes status-bar {
      0% { background-position: 0% 0%; }
      100% { background-position: 200% 0%; }
    }

    .status-card-title {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .status-line {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-weight: 600;
    }

    .dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.8);
      animation: pulse-dot 2s ease-in-out infinite;
    }

    @keyframes pulse-dot {
      0%, 100% { transform: scale(1); box-shadow: 0 0 12px rgba(34, 197, 94, 0.8); }
      50% { transform: scale(1.2); box-shadow: 0 0 20px rgba(34, 197, 94, 1); }
    }

    .dot.stopped {
      background: var(--accent-2);
      box-shadow: 0 0 12px rgba(245, 158, 11, 0.8);
      animation: none;
    }

    .status-meta {
      font-size: 0.82rem;
      color: var(--muted);
      font-family: "IBM Plex Mono", monospace;
      padding: 8px 12px;
      background: rgba(7, 12, 20, 0.6);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.04);
    }

    .status-icon {
      margin-right: 6px;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .tab-btn {
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.04);
      color: var(--muted);
      padding: 10px 18px;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tab-btn.active {
      background: var(--accent);
      color: var(--bg);
      border-color: var(--accent);
    }

    .tab-btn:hover:not(.active) {
      border-color: rgba(45, 212, 191, 0.4);
      background: rgba(45, 212, 191, 0.08);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(280px, 380px) 1fr;
      gap: 20px;
    }

    .side-column {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      box-shadow: var(--shadow);
      animation: rise 0.5s ease both;
    }

    .feed-card {
      min-height: 480px;
      display: flex;
      flex-direction: column;
    }

    .card h2 {
      font-size: 1rem;
      margin-bottom: 12px;
      color: #e0f2fe;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
    }

    label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--muted);
    }

    input,
    textarea {
      width: 100%;
      background: rgba(7, 12, 20, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 10px;
      padding: 10px 12px;
      color: var(--text);
      font-family: "Space Grotesk", sans-serif;
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    .btn-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .btn {
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.06);
      color: var(--text);
      padding: 9px 14px;
      border-radius: 999px;
      font-size: 0.72rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn:hover {
      border-color: rgba(45, 212, 191, 0.6);
      box-shadow: 0 0 0 2px rgba(45, 212, 191, 0.15);
    }

    .btn.danger {
      background: rgba(251, 113, 133, 0.15);
      border-color: rgba(251, 113, 133, 0.45);
      color: #fecdd3;
    }

    .btn.full {
      width: 100%;
    }

    .hint {
      font-size: 0.78rem;
      color: var(--muted);
      line-height: 1.5;
    }

    .feed {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding-right: 4px;
      max-height: 600px;
    }

    .msg {
      padding: 12px 14px;
      border-radius: 12px;
      background: rgba(7, 13, 24, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.06);
    }

    .msg-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 0.8rem;
      color: var(--accent);
      font-weight: 600;
    }

    .msg-body {
      font-size: 0.95rem;
      line-height: 1.45;
      white-space: pre-wrap;
    }

    .audio {
      margin-top: 8px;
    }

    .mono {
      font-family: "IBM Plex Mono", monospace;
      font-size: 0.75rem;
    }

    .agent-grid {
      display: grid;
      gap: 12px;
    }

    .agent-item {
      background: rgba(7, 13, 24, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 10px;
      padding: 12px;
    }

    .agent-name {
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 4px;
    }

    .agent-meta {
      font-size: 0.8rem;
      color: var(--muted);
      display: flex;
      gap: 12px;
    }

    @keyframes rise {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 980px) {
      header {
        grid-template-columns: 1fr;
      }

      .layout {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 640px) {
      body {
        padding: 18px;
      }

      h1 {
        font-size: 1.7rem;
      }
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow);
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 1.2rem;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      color: var(--text);
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .agent-row {
      background: rgba(7, 13, 24, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 10px;
    }

    .agent-row-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .agent-row-title {
      font-weight: 600;
      color: var(--accent);
      font-size: 0.95rem;
    }

    .agent-row-actions {
      display: flex;
      gap: 6px;
    }

    .agent-row-actions button {
      padding: 4px 10px;
      font-size: 0.7rem;
    }

    .agent-row-meta {
      font-size: 0.8rem;
      color: var(--muted);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 8px;
    }

    .agent-row-meta span {
      display: block;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    .badge-success {
      background: rgba(34, 197, 94, 0.2);
      color: var(--success);
    }

    .badge-danger {
      background: rgba(251, 113, 133, 0.2);
      color: var(--danger);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <section class="brand">
        <div class="brand-content">
          <pre class="ascii-art">
   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù
  ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   
  ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   
  ‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   
   ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïù   
  ‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
  ‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù
  ‚ñà‚ñà‚ïî‚ñà‚ñà‚ñà‚ñà‚ïî‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  
  ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  
  ‚ñà‚ñà‚ïë ‚ïö‚ïê‚ïù ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
  ‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù</pre>
          <div class="brand-text">
            <div class="eyebrow">AI Agent Platform</div>
            <h1>ChatMode Unified Console</h1>
            <p class="subtitle">Multi-agent orchestration system with semantic memory, voice synthesis, and real-time conversation control. Deploy intelligent conversations at scale.</p>
            <div class="feature-badges">
              <span class="badge">ü§ñ Multi-Agent</span>
              <span class="badge">üß† Semantic Memory</span>
              <span class="badge orange">üéôÔ∏è Voice TTS</span>
              <span class="badge">‚ö° Real-time</span>
              <span class="badge orange">üîß MCP Tools</span>
            </div>
          </div>
        </div>
      </section>
      <section class="status-card">
        <div class="status-card-title">System Status</div>
        <div class="status-line">
          <span class="dot" id="status-dot"></span>
          <span id="status-text">stopped</span>
        </div>
        <div class="status-meta"><span class="status-icon">üìã</span><span id="topic-line">Topic: Not set</span></div>
        <div class="status-meta"><span class="status-icon">üïê</span><span id="updated-line">Last updated: --</span></div>
      </section>
    </header>

    <div class="tabs">
      <button class="tab-btn active" data-tab="control">Session Control</button>
      <button class="tab-btn" data-tab="monitor">Live Monitor</button>
      <button class="tab-btn" data-tab="agents">Agent Overview</button>
      <button class="tab-btn" data-tab="agentManager">Agent Manager</button>
    </div>

    <!-- Control Tab -->
    <div class="tab-content active" id="control">
      <main class="layout">
        <div class="side-column">
          <section class="card">
            <h2>Session Control</h2>
            <div class="field">
              <label for="topic">Topic</label>
              <input id="topic" type="text" placeholder="Enter a topic" />
            </div>
            <div class="btn-row">
              <button class="btn" id="start-btn">Start</button>
              <button class="btn" id="resume-btn">Resume</button>
              <button class="btn" id="stop-btn">Stop</button>
              <button class="btn danger" id="clear-btn">Clear Memory</button>
            </div>
            <div class="hint">Start creates a fresh session. Resume continues the last topic without clearing memory.</div>
          </section>

          <section class="card">
            <h2>Inject Message</h2>
            <div class="field">
              <label for="sender">Sender</label>
              <input id="sender" type="text" value="Admin" />
            </div>
            <div class="field">
              <label for="content">Message</label>
              <textarea id="content" placeholder="Send a message into the conversation"></textarea>
            </div>
            <button class="btn full" id="send-btn">Send Message</button>
          </section>

          <section class="card">
            <h2>System Info</h2>
            <p class="hint">Auto-polling /status every 2 seconds. Agent manager available via Gradio interface.</p>
            <div class="field" style="margin-top: 12px;">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input id="auto-scroll-toggle" type="checkbox" />
                <span>Enable Auto-Scroll</span>
              </label>
            </div>
            <p class="hint" style="margin-top: 4px; font-size: 0.75rem;">When enabled, chat will scroll to newest messages automatically.</p>
          </section>

          <section class="card">
            <h2>Content Filter</h2>
            <div class="field">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input id="global-filter-toggle" type="checkbox" />
                <span>Enable Content Filter</span>
              </label>
            </div>
            <div id="filter-status" class="hint" style="margin-top: 8px; color: var(--danger);">
              Filter is disabled
            </div>
            <button class="btn full" id="reload-filter-btn" style="margin-top: 12px;">Reload Filter Settings</button>
            <p class="hint" style="margin-top: 8px;">Configure filter rules per-agent in the Agent Manager tab. Filter is OFF by default.</p>
          </section>
        </div>

        <section class="card feed-card">
          <h2>Recent Messages</h2>
          <div class="feed" id="feed"></div>
        </section>
      </main>
    </div>

    <!-- Monitor Tab -->
    <div class="tab-content" id="monitor">
      <main class="layout">
        <section class="card">
          <h2>Quick Actions</h2>
          <div class="btn-row">
            <button class="btn" id="monitor-resume-btn">Resume</button>
            <button class="btn" id="monitor-stop-btn">Stop</button>
            <button class="btn danger" id="monitor-clear-btn">Clear</button>
          </div>
          <div class="field">
            <label for="monitor-topic">New Topic</label>
            <input id="monitor-topic" type="text" placeholder="Enter topic to start" />
          </div>
          <button class="btn full" id="monitor-start-btn">Start New Session</button>
        </section>

        <section class="card feed-card">
          <h2>Live Feed</h2>
          <div class="feed" id="monitor-feed"></div>
        </section>
      </main>
    </div>

    <!-- Agents Tab -->
    <div class="tab-content" id="agents">
      <section class="card">
        <h2>Active Agents</h2>
        <div class="agent-grid" id="agent-list">
          <p class="hint">Loading agents...</p>
        </div>
        <div style="margin-top: 16px;">
          <p class="hint">For full agent management, use the Agent Manager tab.</p>
        </div>
      </section>
    </div>

    <!-- Agent Manager Tab -->
    <div class="tab-content" id="agentManager">
      <!-- Login Section (shown when not authenticated) -->
      <div id="agent-login-section" style="display:none">
        <section class="card" style="max-width: 500px; margin: 40px auto;">
          <h2>Login Required</h2>
          <p class="hint" style="margin-bottom: 16px;">Please login to access Agent Manager.</p>
          <form id="agent-login-form">
            <div class="field">
              <label for="agent-username">Username</label>
              <input id="agent-username" type="text" placeholder="Enter username" required />
            </div>
            <div class="field">
              <label for="agent-password">Password</label>
              <input id="agent-password" type="password" placeholder="Enter password" required />
            </div>
            <div id="agent-login-error" style="color: var(--danger); font-size: 0.85rem; margin-bottom: 12px; display: none;"></div>
            <button type="submit" class="btn full">Login</button>
          </form>
        </section>
      </div>

      <!-- Agent Management Section (shown when authenticated) -->
      <div id="agent-management-section" style="display:none">
        <div class="layout">
          <div class="side-column">
            <section class="card">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2 style="margin-bottom: 0;">Agent Manager</h2>
                <button class="btn" id="agent-logout-btn" style="padding: 6px 12px; font-size: 0.7rem;">Logout</button>
              </div>
              <p class="hint" style="margin-bottom: 12px;">Logged in as: <span id="current-username" style="color: var(--accent);"></span></p>
              <div class="btn-row">
                <button class="btn" id="create-agent-btn">Create Agent</button>
                <button class="btn" id="refresh-agents-btn">Refresh</button>
                <button class="btn" id="sync-state-btn">Sync State</button>
              </div>
            </section>
          </div>

          <section class="card feed-card">
            <h2>Agents</h2>
            <div id="agent-manager-list" class="feed" style="max-height: 600px;">
              <p class="hint">Loading agents...</p>
            </div>
          </section>
        </div>

        <section class="card" style="margin-top: 20px;">
          <h2>Environment Config</h2>
          <p class="hint">Read and update application .env settings. Changes apply on next restart or reload.</p>
          <div class="btn-row" style="margin-top: 12px;">
            <button class="btn" id="env-load-btn">Load .env</button>
            <button class="btn" id="env-save-btn">Save .env</button>
          </div>
          <div class="field" style="margin-top: 12px;">
            <label for="env-content">.env Contents</label>
            <textarea id="env-content" placeholder="Click Load to view .env" style="min-height: 240px;"></textarea>
          </div>
        </section>
      </div>

      <!-- Agent Edit/Create Modal -->
      <div id="agent-modal" class="modal" style="display: none;">
        <div class="modal-content">
          <div class="modal-header">
            <h2 id="agent-modal-title">Create Agent</h2>
            <button class="modal-close" id="agent-modal-close">&times;</button>
          </div>
          <form id="agent-form">
            <div class="modal-body">
              <div class="field">
                <label for="form-agent-name">Name *</label>
                <input id="form-agent-name" type="text" required placeholder="agent_name" />
              </div>
              <div class="field">
                <label for="form-agent-display-name">Display Name</label>
                <input id="form-agent-display-name" type="text" placeholder="Friendly Name" />
              </div>
              <div class="field">
                <label for="form-agent-model">Model *</label>
                <input id="form-agent-model" type="text" required placeholder="gpt-4o" />
              </div>
              <div class="field">
                <label for="form-agent-provider">Provider</label>
                <input id="form-agent-provider" type="text" placeholder="openai" />
              </div>
              <div class="field">
                <label for="form-agent-system-prompt">System Prompt</label>
                <textarea id="form-agent-system-prompt" placeholder="You are a helpful assistant..."></textarea>
              </div>
              <div class="field">
                <label for="form-agent-temperature">Temperature</label>
                <input id="form-agent-temperature" type="number" step="0.1" min="0" max="2" value="0.7" />
              </div>
              <div class="field">
                <label for="form-agent-max-tokens">Max Tokens</label>
                <input id="form-agent-max-tokens" type="number" min="1" value="4096" />
              </div>
              <div class="field">
                <label for="form-agent-sleep-seconds">Sleep Seconds (per agent)</label>
                <input id="form-agent-sleep-seconds" type="number" min="0" step="0.1" placeholder="Use global" />
              </div>
              <div class="field">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input id="form-agent-enabled" type="checkbox" checked />
                  <span>Enabled</span>
                </label>
              </div>

              <!-- Content Filter Section -->
              <div style="border-top: 1px solid var(--border); margin-top: 16px; padding-top: 16px;">
                <h3 style="margin-bottom: 12px; font-size: 1rem; color: var(--accent);">Content Filter Settings</h3>

                <div class="field">
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input id="form-agent-filter-enabled" type="checkbox" />
                    <span>Enable Content Filter</span>
                  </label>
                </div>

                <div class="field">
                  <label for="form-agent-blocked-words">Blocked Words/Phrases (comma-separated)</label>
                  <textarea id="form-agent-blocked-words" placeholder="badword1, badword2, inappropriate phrase"></textarea>
                </div>

                <div class="field">
                  <label for="form-agent-filter-action">Filter Action</label>
                  <select id="form-agent-filter-action" style="width: 100%; padding: 8px; background: var(--bg); color: var(--text); border: 1px solid var(--border); border-radius: 6px;">
                    <option value="block">Block - Reject message entirely</option>
                    <option value="censor">Censor - Replace with asterisks</option>
                    <option value="warn">Warn - Allow but flag</option>
                  </select>
                </div>

                <div class="field">
                  <label for="form-agent-filter-message">Filter Message (shown when content is blocked)</label>
                  <textarea id="form-agent-filter-message" placeholder="This message contains inappropriate content and has been blocked."></textarea>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn" id="agent-form-cancel">Cancel</button>
              <button type="submit" class="btn" style="background: var(--accent); color: var(--bg);">Save Agent</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Agent JSON View Modal -->
      <div id="agent-json-modal" class="modal" style="display: none;">
        <div class="modal-content">
          <div class="modal-header">
            <h2>Agent JSON</h2>
            <button class="modal-close" id="agent-json-modal-close">&times;</button>
          </div>
          <div class="modal-body">
            <pre id="agent-json-content" style="background: rgba(7, 13, 24, 0.9); padding: 16px; border-radius: 8px; overflow-x: auto; max-height: 500px; font-size: 0.85rem;"></pre>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn" id="agent-json-modal-close-btn">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');
    const topicLine = document.getElementById('topic-line');
    const updatedLine = document.getElementById('updated-line');
    const feed = document.getElementById('feed');
    const monitorFeed = document.getElementById('monitor-feed');

    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const targetTab = btn.dataset.tab;
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        btn.classList.add('active');
        document.getElementById(targetTab).classList.add('active');

        if (targetTab === 'agents') {
          loadAgents();
        } else if (targetTab === 'agentManager') {
          loadAgentManager();
        }
      });
    });

    async function postForm(url, data = {}) {
      const body = new URLSearchParams(data);
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body,
      });
      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || `Request failed: ${res.status}`);
      }
      return res;
    }

    function renderMessages(messages = [], container = feed) {
      container.innerHTML = '';
      messages.forEach((msg) => {
        const card = document.createElement('div');
        card.className = 'msg';

        const header = document.createElement('div');
        header.className = 'msg-header';
        header.textContent = msg.sender || 'Agent';
        
        // Add timestamp if available
        if (msg.timestamp) {
          const time = document.createElement('span');
          time.className = 'mono';
          time.style.marginLeft = '8px';
          time.style.color = 'var(--muted)';
          time.style.fontSize = '0.7rem';
          time.textContent = new Date(msg.timestamp).toLocaleTimeString();
          header.appendChild(time);
        }

        const body = document.createElement('div');
        body.className = 'msg-body';
        body.textContent = msg.content || '';

        card.appendChild(header);
        card.appendChild(body);

        if (msg.audio) {
          const audioWrap = document.createElement('div');
          audioWrap.className = 'audio';
          const audio = document.createElement('audio');
          audio.controls = true;
          audio.src = msg.audio;
          audio.onerror = () => {
            audioWrap.innerHTML = '<span class="mono" style="color: var(--danger);">Audio failed to load</span>';
          };
          audioWrap.appendChild(audio);
          card.appendChild(audioWrap);
        } else if (msg.audio_error) {
          // Show TTS error if audio generation failed
          const errorWrap = document.createElement('div');
          errorWrap.className = 'audio mono';
          errorWrap.style.color = 'var(--danger)';
          errorWrap.textContent = `TTS error: ${msg.audio_error}`;
          card.appendChild(errorWrap);
        }

        container.appendChild(card);
      });

      // Only auto-scroll if toggle is enabled
      const autoScrollEnabled = document.getElementById('auto-scroll-toggle')?.checked || false;
      if (autoScrollEnabled) {
        container.scrollTop = container.scrollHeight;
      }
    }

    // Track connection state for reconnect logic
    let connectionLost = false;
    let reconnectAttempts = 0;
    const MAX_RECONNECT_ATTEMPTS = 3;

    async function refreshStatus() {
      try {
        const res = await fetch('/status');
        if (!res.ok) throw new Error('Status unavailable');
        const data = await res.json();
        
        // Reset reconnect state on success
        if (connectionLost) {
          connectionLost = false;
          reconnectAttempts = 0;
          console.log('Connection restored');
        }
        
        const running = Boolean(data.running);
        statusText.textContent = running ? 'running' : 'stopped';
        statusDot.classList.toggle('stopped', !running);
        
        let topicDisplay = data.topic || 'Not set';
        if (data.session_id) {
          topicDisplay += ` (${data.session_id.substring(0, 8)}...)`;
        }
        topicLine.textContent = `Topic: ${topicDisplay}`;
        updatedLine.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;

        renderMessages(data.last_messages || [], feed);
        renderMessages(data.last_messages || [], monitorFeed);
      } catch (err) {
        connectionLost = true;
        reconnectAttempts++;
        
        if (reconnectAttempts <= MAX_RECONNECT_ATTEMPTS) {
          statusText.textContent = `reconnecting (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`;
        } else {
          statusText.textContent = 'offline';
        }
        statusDot.classList.add('stopped');
        updatedLine.textContent = `Last updated: error`;
        console.error('Status refresh failed:', err);
      }
    }

    async function loadAgents() {
      const agentList = document.getElementById('agent-list');
      try {
        const res = await fetch('/agents');
        if (!res.ok) throw new Error('Failed to load agents');
        const data = await res.json();
        
        if (!data.agents || data.agents.length === 0) {
          agentList.innerHTML = '<p class="hint">No agents configured.</p>';
          return;
        }

        agentList.innerHTML = '';
        data.agents.forEach(agent => {
          const item = document.createElement('div');
          item.className = 'agent-item';
          item.innerHTML = `
            <div class="agent-name">${agent.name}</div>
            <div class="agent-meta">
              <span>Model: ${agent.model}</span>
              <span>API: ${agent.api}</span>
            </div>
          `;
          agentList.appendChild(item);
        });
      } catch (err) {
        agentList.innerHTML = `<p class="hint" style="color: var(--danger);">Error: ${err.message}</p>`;
      }
    }

    // Control tab actions with loading states
    function setButtonLoading(btn, loading) {
      btn.disabled = loading;
      btn.style.opacity = loading ? '0.5' : '1';
    }

    document.getElementById('start-btn').addEventListener('click', async () => {
      const topic = document.getElementById('topic').value.trim();
      if (!topic) return alert('Please enter a topic.');
      const btn = document.getElementById('start-btn');
      setButtonLoading(btn, true);
      try {
        await postForm('/start', { topic });
        await refreshStatus();
      } catch (err) {
        alert(err.message || 'Failed to start.');
      } finally {
        setButtonLoading(btn, false);
      }
    });

    document.getElementById('resume-btn').addEventListener('click', async () => {
      const btn = document.getElementById('resume-btn');
      setButtonLoading(btn, true);
      try {
        await postForm('/resume');
        await refreshStatus();
      } catch (err) {
        alert(err.message || 'Failed to resume.');
      } finally {
        setButtonLoading(btn, false);
      }
    });

    document.getElementById('stop-btn').addEventListener('click', async () => {
      const btn = document.getElementById('stop-btn');
      setButtonLoading(btn, true);
      try {
        await postForm('/stop');
        await refreshStatus();
      } catch (err) {
        alert(err.message || 'Failed to stop.');
      } finally {
        setButtonLoading(btn, false);
      }
    });

    document.getElementById('clear-btn').addEventListener('click', async () => {
      if (!confirm('Clear conversation memory?')) return;
      const btn = document.getElementById('clear-btn');
      setButtonLoading(btn, true);
      try {
        await postForm('/memory/clear');
        await refreshStatus();
      } catch (err) {
        alert(err.message || 'Failed to clear memory.');
      } finally {
        setButtonLoading(btn, false);
      }
    });

    document.getElementById('send-btn').addEventListener('click', async () => {
      const sender = document.getElementById('sender').value.trim() || 'Admin';
      const content = document.getElementById('content').value.trim();
      if (!content) return alert('Message is empty.');
      try {
        await postForm('/messages', { sender, content });
        document.getElementById('content').value = '';
        await refreshStatus();
      } catch (err) {
        alert(err.message || 'Failed to send message.');
      }
    });

    // Monitor tab actions
    document.getElementById('monitor-start-btn').addEventListener('click', async () => {
      const topic = document.getElementById('monitor-topic').value.trim();
      if (!topic) return alert('Please enter a topic.');
      try {
        await postForm('/start', { topic });
        await refreshStatus();
      } catch (err) {
        alert(err.message || 'Failed to start.');
      }
    });

    document.getElementById('monitor-resume-btn').addEventListener('click', async () => {
      try {
        await postForm('/resume');
        await refreshStatus();
      } catch (err) {
        alert(err.message || 'Failed to resume.');
      }
    });

    document.getElementById('monitor-stop-btn').addEventListener('click', async () => {
      try {
        await postForm('/stop');
        await refreshStatus();
      } catch (err) {
        alert(err.message || 'Failed to stop.');
      }
    });

    document.getElementById('monitor-clear-btn').addEventListener('click', async () => {
      if (!confirm('Clear conversation memory?')) return;
      try {
        await postForm('/memory/clear');
        await refreshStatus();
      } catch (err) {
        alert(err.message || 'Failed to clear memory.');
      }
    });

    // Content Filter Controls
    const filterToggle = document.getElementById('global-filter-toggle');
    const filterStatus = document.getElementById('filter-status');

    // Load filter status from localStorage
    const savedFilterState = localStorage.getItem('chatmode_filter_enabled');
    if (savedFilterState !== null) {
      filterToggle.checked = savedFilterState === 'true';
      updateFilterStatus(filterToggle.checked);
    }

    function updateFilterStatus(enabled) {
      if (enabled) {
        filterStatus.textContent = 'Filter is active';
        filterStatus.style.color = 'var(--success)';
      } else {
        filterStatus.textContent = 'Filter is disabled';
        filterStatus.style.color = 'var(--danger)';
      }
    }

    filterToggle.addEventListener('change', async () => {
      const enabled = filterToggle.checked;
      localStorage.setItem('chatmode_filter_enabled', enabled);
      updateFilterStatus(enabled);

      // Send toggle request to server
      try {
        const res = await fetch('/filter/toggle', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled })
        });
        if (!res.ok) throw new Error('Failed to toggle filter');
        const data = await res.json();
        console.log('Filter toggled:', data);
      } catch (err) {
        console.error('Error toggling filter:', err);
        alert('Failed to update filter. Server may not support this feature yet.');
      }
    });

    document.getElementById('reload-filter-btn').addEventListener('click', async () => {
      try {
        const res = await fetch('/filter/reload', { method: 'POST' });
        if (!res.ok) throw new Error('Failed to reload filter');
        const data = await res.json();
        alert('Filter settings reloaded successfully!');
        console.log('Filter reloaded:', data);
      } catch (err) {
        console.error('Error reloading filter:', err);
        alert('Failed to reload filter settings.');
      }
    });

    refreshStatus();
    setInterval(refreshStatus, 2000);

    // ============================================================================
    // Agent Manager Functions
    // ============================================================================

    let agentToken = localStorage.getItem('chatmode_agent_token');
    let currentAgentUser = null;
    let editingAgentId = null;

    function loadAgentManager() {
      if (!agentToken) {
        document.getElementById('agent-login-section').style.display = 'block';
        document.getElementById('agent-management-section').style.display = 'none';
      } else {
        document.getElementById('agent-login-section').style.display = 'none';
        document.getElementById('agent-management-section').style.display = 'block';
        fetchCurrentAgentUser();
        loadAgentManagerList();
      }
    }

    async function agentApiCall(endpoint, options = {}) {
      const headers = {
        'Content-Type': 'application/json',
        ...options.headers
      };
      if (agentToken) {
        headers['Authorization'] = `Bearer ${agentToken}`;
      }

      const res = await fetch(endpoint, { ...options, headers });

      if (res.status === 401) {
        // Token expired or invalid
        agentToken = null;
        localStorage.removeItem('chatmode_agent_token');
        loadAgentManager();
        return null;
      }

      return res;
    }

    async function fetchCurrentAgentUser() {
      const res = await agentApiCall('/api/v1/auth/me');
      if (res && res.ok) {
        currentAgentUser = await res.json();
        document.getElementById('current-username').textContent = currentAgentUser.username;
      }
    }

    // Login handler
    document.getElementById('agent-login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('agent-username').value.trim();
      const password = document.getElementById('agent-password').value;
      const errorEl = document.getElementById('agent-login-error');

      try {
        const res = await fetch('/api/v1/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        if (!res.ok) {
          const err = await res.json();
          errorEl.textContent = err.detail?.message || 'Login failed';
          errorEl.style.display = 'block';
          return;
        }

        const data = await res.json();
        agentToken = data.access_token;
        localStorage.setItem('chatmode_agent_token', agentToken);
        errorEl.style.display = 'none';
        loadAgentManager();
      } catch (err) {
        errorEl.textContent = 'Network error. Please try again.';
        errorEl.style.display = 'block';
      }
    });

    // Logout handler
    document.getElementById('agent-logout-btn').addEventListener('click', async () => {
      await agentApiCall('/api/v1/auth/logout', { method: 'POST' });
      agentToken = null;
      currentAgentUser = null;
      localStorage.removeItem('chatmode_agent_token');
      loadAgentManager();
    });

    // Load agent list
    async function loadAgentManagerList() {
      const listEl = document.getElementById('agent-manager-list');
      listEl.innerHTML = '<p class="hint">Loading agents...</p>';

      const res = await agentApiCall('/api/v1/agents/?page=1&per_page=100');
      if (!res || !res.ok) {
        listEl.innerHTML = '<p class="hint" style="color: var(--danger);">Failed to load agents.</p>';
        return;
      }

      const data = await res.json();
      const agents = data.items || [];

      if (agents.length === 0) {
        listEl.innerHTML = '<p class="hint">No agents found. Create one to get started!</p>';
        return;
      }

      listEl.innerHTML = '';
      agents.forEach(agent => {
        const row = document.createElement('div');
        row.className = 'agent-row';

        const enabledBadge = agent.enabled 
          ? '<span class="badge badge-success">Enabled</span>'
          : '<span class="badge badge-danger">Disabled</span>';

        row.innerHTML = `
          <div class="agent-row-header">
            <div>
              <div class="agent-row-title">${agent.display_name || agent.name}</div>
              <div class="mono" style="font-size: 0.75rem; color: var(--muted);">${agent.name}</div>
            </div>
            <div class="agent-row-actions">
              <button class="btn" data-action="edit" data-id="${agent.id}">Edit</button>
              <button class="btn" data-action="json" data-id="${agent.id}">JSON</button>
              <button class="btn danger" data-action="delete" data-id="${agent.id}">Delete</button>
            </div>
          </div>
          <div class="agent-row-meta">
            <span>Model: ${agent.model}</span>
            <span>Provider: ${agent.provider || 'openai'}</span>
            <span>Sleep: ${agent.sleep_seconds ?? 'global'}s</span>
            <span>Status: ${enabledBadge}</span>
          </div>
        `;

        listEl.appendChild(row);
      });

      // Attach event listeners
      listEl.querySelectorAll('button[data-action="edit"]').forEach(btn => {
        btn.addEventListener('click', () => openEditAgentModal(btn.dataset.id));
      });

      listEl.querySelectorAll('button[data-action="json"]').forEach(btn => {
        btn.addEventListener('click', () => openAgentJsonModal(btn.dataset.id));
      });

      listEl.querySelectorAll('button[data-action="delete"]').forEach(btn => {
        btn.addEventListener('click', () => deleteAgentConfirm(btn.dataset.id));
      });
    }

    // Refresh agents button
    document.getElementById('refresh-agents-btn').addEventListener('click', loadAgentManagerList);

    // Sync state button
    document.getElementById('sync-state-btn').addEventListener('click', async () => {
      const res = await agentApiCall('/api/v1/state/sync', { method: 'POST' });
      if (!res || !res.ok) {
        alert('Failed to sync state.');
        return;
      }
      alert('State synchronized successfully.');
      loadAgentManagerList();
    });

    // Create agent button
    document.getElementById('create-agent-btn').addEventListener('click', openCreateAgentModal);

    function openCreateAgentModal() {
      editingAgentId = null;
      document.getElementById('agent-modal-title').textContent = 'Create Agent';
      document.getElementById('agent-form').reset();
      document.getElementById('form-agent-temperature').value = '0.7';
      document.getElementById('form-agent-max-tokens').value = '4096';
      document.getElementById('form-agent-sleep-seconds').value = '';
      document.getElementById('form-agent-enabled').checked = true;
      // Reset filter fields (disabled by default)
      document.getElementById('form-agent-filter-enabled').checked = false;
      document.getElementById('form-agent-blocked-words').value = '';
      document.getElementById('form-agent-filter-action').value = 'block';
      document.getElementById('form-agent-filter-message').value = '';
      document.getElementById('agent-modal').style.display = 'flex';
    }

    async function openEditAgentModal(agentId) {
      editingAgentId = agentId;
      document.getElementById('agent-modal-title').textContent = 'Edit Agent';

      const res = await agentApiCall(`/api/v1/agents/${agentId}`);
      if (!res || !res.ok) {
        alert('Failed to load agent details.');
        return;
      }

      const agent = await res.json();

      document.getElementById('form-agent-name').value = agent.name || '';
      document.getElementById('form-agent-display-name').value = agent.display_name || '';
      document.getElementById('form-agent-model').value = agent.model || '';
      document.getElementById('form-agent-provider').value = agent.provider || '';
      document.getElementById('form-agent-system-prompt').value = agent.system_prompt || '';
      document.getElementById('form-agent-temperature').value = agent.temperature || 0.7;
      document.getElementById('form-agent-max-tokens').value = agent.max_tokens || 4096;
      document.getElementById('form-agent-sleep-seconds').value = agent.sleep_seconds ?? '';
      document.getElementById('form-agent-enabled').checked = agent.enabled !== false;

      // Load filter settings (disabled by default)
      const perms = agent.permissions || {};
      document.getElementById('form-agent-filter-enabled').checked = perms.filter_enabled === true;
      document.getElementById('form-agent-blocked-words').value = (perms.blocked_words || []).join(', ');
      document.getElementById('form-agent-filter-action').value = perms.filter_action || 'block';
      document.getElementById('form-agent-filter-message').value = perms.filter_message || '';

      document.getElementById('agent-modal').style.display = 'flex';
    }

    async function openAgentJsonModal(agentId) {
      const res = await agentApiCall(`/api/v1/agents/${agentId}`);
      if (!res || !res.ok) {
        alert('Failed to load agent details.');
        return;
      }

      const agent = await res.json();
      document.getElementById('agent-json-content').textContent = JSON.stringify(agent, null, 2);
      document.getElementById('agent-json-modal').style.display = 'flex';
    }

    async function deleteAgentConfirm(agentId) {
      if (!confirm('Are you sure you want to delete this agent? This action cannot be undone.')) {
        return;
      }

      const res = await agentApiCall(`/api/v1/agents/${agentId}`, { method: 'DELETE' });
      if (!res || !res.ok) {
        alert('Failed to delete agent.');
        return;
      }

      alert('Agent deleted successfully.');
      loadAgentManagerList();
    }

    // Close modals
    document.getElementById('agent-modal-close').addEventListener('click', () => {
      document.getElementById('agent-modal').style.display = 'none';
    });

    document.getElementById('agent-form-cancel').addEventListener('click', () => {
      document.getElementById('agent-modal').style.display = 'none';
    });

    document.getElementById('agent-json-modal-close').addEventListener('click', () => {
      document.getElementById('agent-json-modal').style.display = 'none';
    });

    document.getElementById('agent-json-modal-close-btn').addEventListener('click', () => {
      document.getElementById('agent-json-modal').style.display = 'none';
    });

    // Save agent form
    document.getElementById('agent-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const agentData = {
        name: document.getElementById('form-agent-name').value.trim(),
        display_name: document.getElementById('form-agent-display-name').value.trim() || null,
        model: document.getElementById('form-agent-model').value.trim(),
        provider: document.getElementById('form-agent-provider').value.trim() || 'openai',
        system_prompt: document.getElementById('form-agent-system-prompt').value.trim() || null,
        temperature: parseFloat(document.getElementById('form-agent-temperature').value) || 0.7,
        max_tokens: parseInt(document.getElementById('form-agent-max-tokens').value) || 4096,
        sleep_seconds: document.getElementById('form-agent-sleep-seconds').value.trim() === ''
          ? null
          : parseFloat(document.getElementById('form-agent-sleep-seconds').value),
        enabled: document.getElementById('form-agent-enabled').checked
      };

      const method = editingAgentId ? 'PUT' : 'POST';
      const endpoint = editingAgentId
        ? `/api/v1/agents/${editingAgentId}`
        : '/api/v1/agents/';

      const res = await agentApiCall(endpoint, {
        method,
        body: JSON.stringify(agentData)
      });

      if (!res || !res.ok) {
        const err = await res.json();
        alert(`Failed to save agent: ${err.detail?.message || 'Unknown error'}`);
        return;
      }

      const savedAgent = await res.json();
      const agentId = editingAgentId || savedAgent.id;

      // Save filter/permissions settings
      const blockedWordsRaw = document.getElementById('form-agent-blocked-words').value.trim();
      const blockedWords = blockedWordsRaw
        ? blockedWordsRaw.split(',').map(w => w.trim()).filter(w => w)
        : [];

      const permissionsData = {
        filter_enabled: document.getElementById('form-agent-filter-enabled').checked,
        blocked_words: blockedWords,
        filter_action: document.getElementById('form-agent-filter-action').value,
        filter_message: document.getElementById('form-agent-filter-message').value.trim() || null
      };

      const permsRes = await agentApiCall(`/api/v1/agents/${agentId}/permissions`, {
        method: 'PUT',
        body: JSON.stringify(permissionsData)
      });

      if (!permsRes || !permsRes.ok) {
        console.warn('Failed to save permissions, but agent was saved');
      }

      document.getElementById('agent-modal').style.display = 'none';
      alert(editingAgentId ? 'Agent updated successfully.' : 'Agent created successfully.');
      loadAgentManagerList();
    });

    // Env config load/save
    document.getElementById('env-load-btn').addEventListener('click', async () => {
      const res = await agentApiCall('/api/v1/config/env');
      if (!res || !res.ok) {
        alert('Failed to load .env');
        return;
      }
      const data = await res.json();
      document.getElementById('env-content').value = data.content || '';
    });

    document.getElementById('env-save-btn').addEventListener('click', async () => {
      const content = document.getElementById('env-content').value;
      const res = await agentApiCall('/api/v1/config/env', {
        method: 'PUT',
        body: JSON.stringify({ content })
      });
      if (!res || !res.ok) {
        alert('Failed to save .env');
        return;
      }
      alert('.env saved successfully.');
    });

    // Click outside modal to close
    document.getElementById('agent-modal').addEventListener('click', (e) => {
      if (e.target.id === 'agent-modal') {
        document.getElementById('agent-modal').style.display = 'none';
      }
    });

    document.getElementById('agent-json-modal').addEventListener('click', (e) => {
      if (e.target.id === 'agent-json-modal') {
        document.getElementById('agent-json-modal').style.display = 'none';
      }
    });
  </script>
</body>
</html>
