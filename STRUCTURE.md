# ChatMode Directory Structure

This document describes the clean, organized directory structure of ChatMode after refactoring.

## Overview

ChatMode follows a modular architecture with clear separation between:
- **Core application** (chatmode/ package)
- **Entry points** (web_admin.py, bootstrap scripts)
- **Configuration** (requirements.txt, environment.yml, .env)
- **Runtime data** (data/, tts_out/)
- **User content** (profiles/, templates/, frontend/)
- **Documentation** (docs/, README.md)
- **Tests** (tests/)

---

## Root Directory

### Essential Files

| File | Purpose | Usage |
|------|---------|-------|
| `web_admin.py` | Main FastAPI application entry point | `uvicorn web_admin:app --host 0.0.0.0 --port 8002` |
| `bootstrap.py` | Database initialization and setup | `python bootstrap.py` |
| `bootstrap_admin.py` | Create initial admin user | `python bootstrap_admin.py` |
| `install.sh` | Simplified installation script (Linux/macOS) | `./install.sh` |
| `uninstall.sh` | Clean uninstallation script | `./uninstall.sh` |
| `autoinstall.sh` | Comprehensive auto-installer (Linux/macOS) | `./autoinstall.sh` |
| `autoinstall.bat` | Comprehensive auto-installer (Windows) | `autoinstall.bat` |
| `requirements.txt` | Python package dependencies | `pip install -r requirements.txt` |
| `environment.yml` | Conda environment specification | `conda env create -f environment.yml` |
| `Dockerfile` | Docker image definition | `docker build -t chatmode .` |
| `compose.yaml` | Docker Compose configuration | `docker compose up` |
| `README.md` | Main project documentation | - |

### Configuration Files (Runtime)

| File | Purpose | Generated By |
|------|---------|--------------|
| `.env` | Environment variables (API keys, settings) | User/installer (from .env.example) |
| `.gitignore` | Git ignore patterns | Source control |

---

## Core Application (`chatmode/`)

The main Python package containing all application logic.

### Structure

```
chatmode/
├── __init__.py              # Package initialization
├── config.py                # Configuration management (Settings class)
├── models.py                # SQLAlchemy database models
├── schemas.py               # Pydantic schemas for API
├── database.py              # Database connection and setup
├── auth.py                  # Authentication (JWT, password hashing)
├── crud.py                  # Database CRUD operations
├── agent.py                 # ChatAgent class (core agent logic)
├── admin.py                 # AdminAgent class (topic generation)
├── session.py               # ChatSession class (conversation management)
├── memory.py                # MemoryStore class (ChromaDB integration)
├── providers.py             # LLM/Embedding provider abstractions
├── llm_config.py            # LLM configuration helpers
├── tts.py                   # Text-to-speech integration
├── tts_provider.py          # TTS provider abstractions
├── content_filter.py        # Content filtering system
├── agent_state.py           # Agent state management
├── state_sync.py            # Database/profile synchronization
├── audit.py                 # Audit logging system
├── logger_config.py         # Logging configuration
├── utils.py                 # Utility functions
├── routes/                  # API route modules
│   ├── __init__.py
│   ├── auth_routes.py       # /api/v1/auth/* (login, logout)
│   ├── users.py             # /api/v1/users/* (user management)
│   ├── agents.py            # /api/v1/agents/* (agent CRUD)
│   ├── conversations.py     # /api/v1/conversations/* (session control)
│   ├── audio.py             # /api/v1/audio/* (TTS)
│   ├── advanced.py          # /api/v1/tools/*, /transcript/* (tools, export)
│   ├── providers.py         # /api/v1/providers/* (provider management)
│   ├── filter.py            # /api/v1/filter/* (content filter)
│   ├── audit_routes.py      # /api/v1/audit/* (audit logs)
│   └── env_config.py        # /api/v1/env-config (frontend config)
└── services/                # Service layer
    ├── __init__.py
    ├── provider_init.py     # Provider initialization
    └── provider_sync.py     # Provider synchronization
```

### Key Components

#### Core Classes
- **Settings** (`config.py`): Configuration management using Pydantic
- **ChatAgent** (`agent.py`): Individual AI agent with personality and memory
- **AdminAgent** (`admin.py`): Special agent for topic generation
- **ChatSession** (`session.py`): Manages multi-agent conversations
- **MemoryStore** (`memory.py`): Semantic memory with ChromaDB

#### Provider System
- **OpenAIChatProvider** (`providers.py`): OpenAI API integration
- **OllamaChatProvider** (`providers.py`): Ollama local LLM integration
- **OllamaEmbeddingProvider** (`providers.py`): Ollama embeddings
- **OpenAIEmbeddingProvider** (`providers.py`): OpenAI embeddings

#### API Routes (FastAPI)
All routes are organized by feature in `chatmode/routes/`:
- Authentication: `/api/v1/auth/*`
- User management: `/api/v1/users/*`
- Agent management: `/api/v1/agents/*`
- Session control: `/api/v1/conversations/*`
- Audio/TTS: `/api/v1/audio/*`
- Advanced features: `/api/v1/tools/*`, `/api/v1/transcript/*`

---

## Tests (`tests/`)

Comprehensive test suite using pytest.

```
tests/
├── __init__.py
├── conftest.py                   # Shared fixtures
├── test_api.py                   # API endpoint tests
├── test_chatmode.py              # Core functionality tests
├── test_simple.py                # Simple smoke tests
├── test_advanced_features.py     # Advanced feature tests
├── test_smoke_tests.py           # Full smoke test suite
├── test_integration_llm_tts.py   # LLM/TTS integration tests
└── test_tts_and_state.py         # TTS and state management tests
```

### Running Tests

```bash
# Run all tests
pytest tests/ -v

# Run specific test file
pytest tests/test_api.py -v

# Run with coverage
pytest tests/ --cov=chatmode --cov-report=html
```

---

## Documentation (`docs/`)

Comprehensive documentation organized by topic.

```
docs/
├── ADVANCED_FEATURES.md             # MCP tools, custom prompts, memory management
├── AGENTS.md                        # Agent configuration and management
├── ARCHITECTURE.md                  # System architecture overview
├── CONFIG.md                        # Configuration reference
├── CONTENT_FILTER.md                # Content filtering system
├── LOGGING.md                       # Logging and debugging
├── MIGRATION_GUIDE.md               # Migration from older versions
├── PROVIDER_IMPLEMENTATION_SUMMARY.md  # Provider system details
├── PROVIDER_SYSTEM.md               # Provider configuration
├── SETUP.md                         # Installation and deployment
├── SMOKE_TESTS.md                   # Smoke testing guide
├── TROUBLESHOOTING.md               # Common issues and solutions
└── VOICE.md                         # TTS configuration
```

---

## User Content

### Agent Profiles (`profiles/`)

JSON files defining agent personalities. Each file contains:
- Agent name and description
- LLM model and API configuration
- System prompts and personality traits
- Memory settings
- Content filter rules
- MCP tool configuration (optional)

Example profiles: `sunny.json`, `jolly.json`, `lawyer.json`, etc.

### HTML Templates (`templates/`)

Jinja2 templates for server-side rendering:
- `admin.html` - Admin interface template

### Frontend (`frontend/`)

Web interface components:
- `unified.html` - Single-page admin console
- `react-app/` - React-based frontend (if using)
- `settings_spec.json` - Frontend configuration schema

---

## Runtime Data

### Database and Vectors (`data/`)

```
data/
├── chatmode.db          # SQLite database (users, agents, sessions)
└── chroma/              # ChromaDB vector database (semantic memory)
```

**Note:** These directories are created automatically by the application. They are excluded from git via `.gitignore`.

### Audio Output (`tts_out/`)

Generated TTS audio files (`.wav`, `.mp3`). Excluded from git.

---

## CI/CD (`.github/`)

```
.github/
└── workflows/
    └── ci.yml           # GitHub Actions workflow for automated testing
```

---

## Installation Scripts

### Linux/macOS

1. **install.sh** - Simplified entry point
   - Checks for conda
   - Delegates to autoinstall.sh

2. **autoinstall.sh** - Comprehensive installer
   - Creates conda environment
   - Installs dependencies
   - Initializes database
   - Configures environment
   - Detects API providers
   - Offers to launch

3. **uninstall.sh** - Clean removal
   - Removes conda environment
   - Deletes runtime data
   - Preserves source code and config

### Windows

1. **autoinstall.bat** - Comprehensive installer
   - All features of autoinstall.sh
   - Windows-specific commands

---

## Excluded from Git

The following are generated at runtime and excluded via `.gitignore`:

### Build Artifacts
- `__pycache__/`
- `*.pyc`
- `frontend/dist/`
- `frontend/react-app/node_modules/`

### Runtime Data
- `data/chroma/`
- `data/*.db`
- `*.sqlite3`

### Logs and Temporary Files
- `*.log`
- `*.out`
- `logs/`

### Environment and Secrets
- `.env`
- `.env.*` (except `.env.example`)

### Generated Audio
- `tts_out/*.wav`
- `tts_out/*.mp3`

---

## Quick Reference

### Start the Application

```bash
# Activate environment
conda activate chatmode

# Start server
uvicorn web_admin:app --host 0.0.0.0 --port 8002

# Access UI
open http://localhost:8002
```

### Common Operations

```bash
# Install
./install.sh

# Initialize database
python bootstrap_admin.py

# Run tests
pytest tests/ -v

# Uninstall
./uninstall.sh
```

---

## File Count Summary

| Category | Count | Notes |
|----------|-------|-------|
| Root files | 12 | Essential entry points and config |
| Core package | 25+ | chatmode/ Python modules |
| API routes | 10 | chatmode/routes/ modules |
| Tests | 8 | Comprehensive test coverage |
| Documentation | 13 | Complete guides and references |
| Agent profiles | 40+ | Pre-configured personalities |
| **Total essential files** | **~108** | Excluding runtime data |

---

## Design Principles

1. **Separation of Concerns**: Clear boundaries between API, business logic, and data access
2. **Modularity**: Each module has a single, well-defined responsibility
3. **Configuration Over Code**: Behavior controlled via .env and profile JSON files
4. **Documentation**: Every feature documented with examples
5. **Testing**: Comprehensive test coverage for core functionality
6. **Clean Structure**: No obsolete files, clear naming conventions
7. **Easy Installation**: One-command setup with automated installers

---

**Last Updated**: 2026-02-02  
**Version**: 2.0.0 (after refactoring)
